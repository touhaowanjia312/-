# 仓位计算和余额问题解决方案

## 问题诊断

### Bitget - 余额不足

**原因分析**：
```
账户余额：13.69 USDT
原配置：
  - use_margin_amount: true
  - margin_amount: 2.0 USDT
  - default_leverage: 20x

计算过程（以LIGHT币为例，价格0.942）：
  - 开仓金额 = 2.0 * 20 = 40 USDT
  - 币数量 = 40 / 0.942 = 42.46 个LIGHT币
  - 所需保证金 ≈ 2 USDT + 手续费 + 缓冲
```

**问题**：
1. 固定保证金模式下，每次开仓使用40 USDT合约价值
2. 对于13.69 USDT的小账户，连续几笔交易就会耗尽保证金
3. Bitget需要额外的风险缓冲金，实际可用保证金可能只有账户余额的70-80%

### LBANK - API权限问题

**错误信息**：`Invalid authorization`

**原因**：
1. API密钥可能没有正确的合约交易权限
2. LBANK需要重新创建API密钥，不能只是勾选权限
3. IP白名单设置可能有问题

## 解决方案

### 1. Bitget - 改用风险百分比模式 ✅

**新配置**：
```json
{
  "use_margin_amount": false,      // 改为false
  "risk_percentage": 10.0,         // 使用账户余额的10%
  "margin_amount": 2.0             // 保留但不使用
}
```

**效果**：
```
账户余额：13.69 USDT
风险金额：13.69 * 10% = 1.369 USDT
杠杆：20x
开仓金额：1.369 * 20 = 27.38 USDT

以LIGHT币为例（价格0.942）：
币数量 = 27.38 / 0.942 ≈ 29.06 个LIGHT币
```

**优点**：
- ✅ 自动根据账户余额调整仓位
- ✅ 避免过度使用保证金
- ✅ 更安全的资金管理
- ✅ 账户余额增长时，仓位也会自动增大

### 2. LBANK - 暂时禁用 ⚠️

**新配置**：
```json
{
  "enabled": false  // 暂时禁用
}
```

**需要解决的问题**：

#### 选项A：重新创建API密钥（推荐）

1. **登录LBANK官网**
2. **删除旧的API密钥**
3. **创建新的API密钥**：
   - ✅ 勾选"合约交易"权限
   - ✅ 勾选"读取"权限
   - ✅ 如果有IP白名单，添加您的IP或选择"不限制"
   - ⚠️ 注意：创建时必须勾选权限，后续无法修改
4. **记录新的API Key和Secret**
5. **在GUI中更新配置**

#### 选项B：检查现有API密钥

1. 登录LBANK官网
2. 查看API管理页面
3. 确认权限：
   - ✅ 合约交易：已启用
   - ✅ 读取权限：已启用
   - ✅ IP白名单：正确或未设置
4. 如果权限正确但仍然失败，建议删除并重新创建

## 配置参数说明

### use_margin_amount（保证金模式选择）

**false - 风险百分比模式**（推荐用于小账户）：
```
仓位大小 = (账户余额 * risk_percentage / 100) * 杠杆 / 币价
```
- 优点：自动根据余额调整
- 适合：余额较小或波动的账户
- 示例：13.69 USDT余额，10%风险 → 每次约1.37 USDT保证金

**true - 固定保证金模式**（适合大账户）：
```
仓位大小 = (margin_amount * 杠杆) / 币价
```
- 优点：每次开仓金额固定，便于控制
- 适合：余额充足的账户
- 示例：2 USDT保证金 × 20倍 → 每次开40 USDT仓位

### risk_percentage（风险百分比）

建议值：
- **10%**：保守，适合小账户或新手
- **20%**：平衡，适合中等账户
- **30%**：激进，仅适合大账户且有经验

### default_leverage（杠杆倍数）

注意事项：
- Bitget最高125倍，建议10-20倍
- LBANK最高125倍，建议10-25倍
- 杠杆越高风险越大，建议新手使用10倍以下

## 测试建议

### 1. 重启程序
```bash
# 停止当前运行的程序
taskkill /F /IM python.exe

# 重新启动
python gui_main.py
```

### 2. 检查日志
程序会显示：
```
INFO:telegram_client:  仓位大小: X.XXXXXX
```
确认仓位大小在合理范围内。

### 3. 小额测试
建议先：
1. 等待下一个信号
2. 观察程序自动计算的仓位大小
3. 如果仓位合理（<账户余额的50%），则自动下单
4. 如果仍然失败，检查日志中的具体错误

## 当前配置状态

✅ **Bitget**：已启用，风险百分比模式（10%余额）
⚠️ **LBANK**：已禁用，等待API权限修复

## 下一步

1. **立即可用**：Bitget已配置好，重启程序即可使用
2. **修复LBANK**：
   - 登录LBANK官网
   - 重新创建API密钥（确保勾选合约交易权限）
   - 在GUI中更新API密钥
   - 将`enabled`改为`true`
3. **监控运行**：观察几笔交易，确认仓位大小合理

## 实际示例计算

假设下一个信号是 `#XYZ 市价多`，价格1.5 USDT：

**Bitget（风险百分比10%）**：
```
余额：13.69 USDT
风险金额：13.69 * 10% = 1.369 USDT
杠杆：20x
开仓金额：1.369 * 20 = 27.38 USDT
币数量：27.38 / 1.5 = 18.25 个XYZ币

所需保证金：约1.4 USDT
剩余可用：13.69 - 1.4 = 12.29 USDT ✅ 安全
```

**之前的固定保证金模式**：
```
保证金：2.0 USDT
杠杆：20x
开仓金额：2.0 * 20 = 40 USDT
币数量：40 / 1.5 = 26.67 个XYZ币

所需保证金：约2.0 USDT
剩余可用：13.69 - 2.0 = 11.69 USDT
问题：连开3笔就会接近爆仓边缘 ⚠️
```

## 总结

✅ **Bitget问题已解决**：改用风险百分比模式，更适合小账户
⚠️ **LBANK需要处理**：重新创建API密钥并启用合约交易权限

配置文件已更新，重启程序即可生效！

