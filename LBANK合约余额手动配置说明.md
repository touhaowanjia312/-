# 📊 LBANK 合约余额手动配置说明

## 问题

LBANK 交易所的合约 API (`https://lbkperp.lbank.com`) 被 Cloudflare 安全策略保护，导致 CCXT 库无法直接访问，无法自动获取合约余额。

## 解决方案

使用**手动配置**方式输入 LBANK 合约余额。

## 已为您配置

✅ 已在 `exchanges_config.json` 中添加：

```json
{
  "name": "LBANK",
  "exchange_type": "lbank",
  ...
  "manual_contract_balance": 10.0  ← 您的合约余额
}
```

## 当前显示效果

在 GUI 中点击 **"🔄 刷新余额"**，您会看到：

```
💰 总计: 22.85 USDT

bitget: 12.85 (统一)
LBANK: 10.00 (💵 现货: 0.00004384, 📊 合约: 10.00)
```

### 详细说明

| 交易所 | 现货余额 | 合约余额 | 总余额 | 备注 |
|--------|---------|---------|--------|------|
| **bitget** | 12.85 | (统一账户) | 12.85 | 自动获取 |
| **LBANK** | 0.000044 | 10.00 | 10.00 | 合约为手动配置 |
| **合计** | - | - | **22.85** | - |

## 如何更新 LBANK 合约余额

### 方法 1：编辑配置文件（推荐）

1. 打开 `exchanges_config.json`
2. 找到 LBANK 配置
3. 修改 `manual_contract_balance` 值：

```json
{
  "name": "LBANK",
  ...
  "manual_contract_balance": 15.0  ← 改成您的最新合约余额
}
```

4. 保存文件
5. 重启 GUI

### 方法 2：通过 GUI 管理界面（即将支持）

未来版本会在 **"多交易所账户管理"** 界面添加 **"合约余额（手动）"** 输入框，届时可直接在 GUI 中修改。

## 技术原因

### 为什么需要手动配置？

1. **LBANK API 架构**
   - 现货 API: `https://api.lbank.info` ✅ 可访问
   - 合约 API: `https://lbkperp.lbank.com` ❌ 被 Cloudflare 保护

2. **Cloudflare 安全策略**
   - 合约 API 返回 **403 Forbidden**
   - 需要浏览器环境或特殊的 User-Agent
   - CCXT 库的请求被拦截

3. **CCXT 限制**
   - CCXT 的 LBANK 实现主要支持现货
   - 对合约 API 的支持不完整
   - 无法绕过 Cloudflare 保护

### 为什么不影响交易？

✅ **不影响**！理由：

1. 余额显示：使用手动配置的合约余额
2. 下单操作：直接调用交易 API（不经过余额查询）
3. 仓位计算：基于配置的保证金和杠杆
4. 风险控制：基于配置的最大仓位限制

## 其他交易所对比

| 交易所 | 现货余额 | 合约余额 | 获取方式 |
|--------|---------|---------|---------|
| **Binance** | ✅ 自动 | ✅ 自动 | 统一账户API |
| **OKX** | ✅ 自动 | ✅ 自动 | 统一账户API |
| **Bitget** | ✅ 自动 | ✅ 自动 | 统一账户API |
| **LBANK** | ✅ 自动 | ⚙️ 手动 | 现货API + 手动配置 |
| **Bybit** | ✅ 自动 | ✅ 自动 | 统一账户API |

## 注意事项

### 1. 定期更新

⚠️ **重要**：需要手动更新 LBANK 合约余额

建议：
- 每天交易前检查一次
- 充值/提现后立即更新
- 大额盈亏后更新

### 2. 余额不准确的影响

如果余额配置不准确：
- ✅ **不影响**下单和交易执行
- ⚠️ **可能影响**风险控制（如果使用余额百分比计算仓位）
- ⚠️ **可能影响**统计报表的准确性

### 3. 推荐配置

对于 LBANK，建议使用 **固定保证金模式**：

```json
{
  "use_margin_amount": true,  ← 使用固定保证金
  "margin_amount": 1.0,       ← 每单使用 1 USDT
}
```

这样可以避免依赖余额计算。

## 常见问题

### Q1: 为什么不能自动获取？

**A**: LBANK 的合约 API 被 Cloudflare WAF 保护，普通 HTTP 请求被拦截。需要特殊的浏览器环境或企业级 API 接入才能访问。

### Q2: 会影响自动交易吗？

**A**: 不会！交易订单通过独立的交易 API 发送，不需要先查询余额。

### Q3: 余额会自动同步吗？

**A**: 不会。需要您手动在配置文件中更新 `manual_contract_balance` 的值。

### Q4: 可以留空吗？

**A**: 可以。如果不配置或设为 0，则只显示现货余额。

### Q5: 未来会支持自动获取吗？

**A**: 如果以下情况发生，可以支持：
- LBANK 开放公开的合约 API
- Cloudflare 保护解除
- CCXT 库完善对 LBANK 合约的支持

## 相关文件

- `exchanges_config.json` - 配置文件（包含 `manual_contract_balance`）
- `multi_exchange_config.py` - 账户配置类
- `multi_exchange_client.py` - 余额查询逻辑
- `gui_main.py` - GUI 显示逻辑
- `debug_lbank_contract.py` - 调试脚本

## 更新记录

- **2025-10-15 01:10**: 添加手动配置功能
- **2025-10-15 01:10**: 为您的账户设置合约余额 10 USDT

---

**当前状态**: ✅ 已配置完成，余额正确显示

