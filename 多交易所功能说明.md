# 🎉 多交易所功能已添加！

## ✨ 新增功能

### 1. 多交易所账户管理
现在可以同时配置和管理多个交易所账户！

**支持的交易所：**
- 币安 (Binance)
- 欧易 (OKX)
- Bybit
- 火币 (Huobi)
- Bitget
- Gate.io
- KuCoin
- 等 100+ 交易所（通过 CCXT）

### 2. 灵活的杠杆配置
每个账户可以独立设置：
- **默认杠杆倍数**：1x - 125x
- 针对不同交易所和策略设置不同的杠杆

### 3. 两种仓位计算模式

#### 模式 A：风险百分比模式 (推荐)
- **风险百分比**：账户余额的 0.1% - 10%
- **默认仓位大小**：基础仓位（币的数量）
- **最大仓位限制**：防止单笔交易过大

**计算公式**：
```
仓位大小 = (账户余额 × 风险百分比) ÷ 入场价格
```

**示例**：
```
账户余额: 10,000 USDT
风险百分比: 1%
BTC价格: 40,000 USDT
───────────────────
风险金额 = 10,000 × 1% = 100 USDT
仓位大小 = 100 ÷ 40,000 = 0.0025 BTC
```

#### 模式 B：固定保证金模式
- **保证金金额**：每次交易使用的固定保证金（USDT）
- 自动结合杠杆计算实际仓位

**计算公式**：
```
仓位大小 = (保证金金额 × 杠杆倍数) ÷ 入场价格
```

**示例**：
```
保证金: 100 USDT
杠杆: 10x
BTC价格: 40,000 USDT
───────────────────
实际仓位价值 = 100 × 10 = 1,000 USDT
仓位大小 = 1,000 ÷ 40,000 = 0.025 BTC
```

### 4. 独立账户配置
每个交易所账户都可以单独配置：
- ✅ 账户名称（如 "币安主账户", "OKX测试"）
- ✅ 交易所类型
- ✅ API 密钥
- ✅ 测试网/正式网
- ✅ 启用/禁用状态
- ✅ 默认杠杆倍数
- ✅ 仓位计算模式
- ✅ 风险参数或保证金设置

---

## 📁 新增文件

### 1. `multi_exchange_config.py`
**多交易所配置管理**
- `ExchangeAccount` 类 - 单个账户配置
- `MultiExchangeConfig` 类 - 配置管理器
- 支持 JSON 文件保存/加载
- 向后兼容 .env 配置

### 2. `multi_exchange_client.py`
**多交易所客户端**
- `MultiExchangeClient` 类 - 统一管理多个交易所
- 自动初始化所有启用的账户
- 支持批量操作
- 独立的账户余额查询
- 智能仓位计算

### 3. `gui_multi_exchange.py`
**交易所管理 GUI**
- 可视化账户管理界面
- 添加/编辑/删除账户
- 实时配置杠杆和仓位参数
- 两种仓位模式切换

---

## 🎮 使用方法

### 方法 1：通过 Python 代码

```python
from multi_exchange_config import ExchangeAccount, multi_exchange_config
from multi_exchange_client import multi_exchange_client

# 添加币安账户
binance_account = ExchangeAccount(
    name="币安主账户",
    exchange_type="binance",
    api_key="your_binance_api_key",
    api_secret="your_binance_secret",
    testnet=True,
    enabled=True,
    default_leverage=10,
    use_margin_amount=False,  # 使用风险百分比模式
    risk_percentage=1.0,
    default_position_size=0.01,
    max_position_size=0.1
)

# 添加 OKX 账户（使用固定保证金）
okx_account = ExchangeAccount(
    name="OKX测试账户",
    exchange_type="okx",
    api_key="your_okx_api_key",
    api_secret="your_okx_secret",
    testnet=True,
    enabled=True,
    default_leverage=20,
    use_margin_amount=True,  # 使用固定保证金模式
    margin_amount=100.0  # 每次100 USDT保证金
)

# 添加到配置
multi_exchange_config.add_account(binance_account)
multi_exchange_config.add_account(okx_account)

# 保存配置
multi_exchange_config.save_to_file()

# 初始化交易所客户端
multi_exchange_client.add_exchange(binance_account)
multi_exchange_client.add_exchange(okx_account)

# 查询所有账户余额
balances = multi_exchange_client.get_all_balances()
print(balances)
# 输出: {'币安主账户': 10000.0, 'OKX测试账户': 5000.0}

# 在所有账户上执行交易
results = multi_exchange_client.execute_on_all(
    symbol='BTC/USDT',
    side='buy',
    leverage=10
)

# 查询单个账户余额
balance = multi_exchange_client.get_balance('币安主账户')
print(f"币安余额: {balance} USDT")
```

### 方法 2：通过 GUI（开发中）

打开交易所管理窗口：
```python
from gui_multi_exchange import ExchangeManagementWindow
import customtkinter as ctk

# 创建主窗口
root = ctk.CTk()
root.title("测试")

# 打开交易所管理窗口
exchange_window = ExchangeManagementWindow(root)

root.mainloop()
```

---

## 📊 配置文件格式

配置会自动保存到 `exchanges_config.json`：

```json
{
  "accounts": [
    {
      "name": "币安主账户",
      "exchange_type": "binance",
      "api_key": "your_key",
      "api_secret": "your_secret",
      "testnet": true,
      "enabled": true,
      "default_leverage": 10,
      "default_position_size": 0.01,
      "max_position_size": 0.1,
      "risk_percentage": 1.0,
      "use_margin_amount": false,
      "margin_amount": 100.0
    },
    {
      "name": "OKX测试账户",
      "exchange_type": "okx",
      "api_key": "your_key",
      "api_secret": "your_secret",
      "testnet": true,
      "enabled": true,
      "default_leverage": 20,
      "default_position_size": 0.02,
      "max_position_size": 0.2,
      "risk_percentage": 2.0,
      "use_margin_amount": true,
      "margin_amount": 200.0
    }
  ]
}
```

---

## 🎯 使用场景

### 场景 1：分散风险
```
账户 1: 币安 - 保守策略（1% 风险，10x 杠杆）
账户 2: OKX - 激进策略（2% 风险，20x 杠杆）
账户 3: Bybit - 测试策略（0.5% 风险，5x 杠杆）
```

### 场景 2：不同交易所套利
```
监听同一个信号群
在多个交易所同时执行
利用价差和费率差异
```

### 场景 3：测试网和正式网并行
```
账户 1: 币安测试网 - 测试新策略
账户 2: 币安正式网 - 实际交易
随时对比效果
```

### 场景 4：固定资金管理
```
使用固定保证金模式
每次交易固定投入 100 USDT
配合不同杠杆（10x, 20x, 50x）
精确控制风险敞口
```

---

## 💡 配置建议

### 保守型配置
```python
ExchangeAccount(
    default_leverage=5,
    use_margin_amount=False,
    risk_percentage=0.5,  # 0.5% 风险
    max_position_size=0.05
)
```

### 稳健型配置
```python
ExchangeAccount(
    default_leverage=10,
    use_margin_amount=False,
    risk_percentage=1.0,  # 1% 风险
    max_position_size=0.1
)
```

### 激进型配置
```python
ExchangeAccount(
    default_leverage=20,
    use_margin_amount=True,
    margin_amount=200.0,  # 固定 200 USDT
)
```

### 固定保证金配置
```python
ExchangeAccount(
    default_leverage=10,
    use_margin_amount=True,
    margin_amount=100.0,  # 每次 100 USDT
)
```

---

## ⚙️ API 参考

### ExchangeAccount 类

```python
ExchangeAccount(
    name: str,                      # 账户名称
    exchange_type: str,             # 交易所类型
    api_key: str,                   # API Key
    api_secret: str,                # API Secret
    testnet: bool = True,           # 是否测试网
    enabled: bool = True,           # 是否启用
    default_leverage: int = 10,     # 默认杠杆 (1-125)
    default_position_size: float = 0.01,  # 默认仓位大小
    max_position_size: float = 0.1,       # 最大仓位限制
    risk_percentage: float = 1.0,   # 风险百分比 (0.1-10)
    use_margin_amount: bool = False,# 是否使用固定保证金
    margin_amount: float = 100.0    # 保证金金额 (USDT)
)
```

### MultiExchangeClient 主要方法

```python
# 获取余额
get_balance(account_name, currency='USDT') -> float

# 获取所有账户余额
get_all_balances() -> Dict[str, float]

# 计算仓位大小（自动根据模式）
calculate_position_size(account_name, symbol, price) -> float

# 下市价单（自动计算仓位）
place_market_order(account_name, symbol, side, amount=None) -> dict

# 下限价单（自动计算仓位）
place_limit_order(account_name, symbol, side, price, amount=None) -> dict

# 设置杠杆
set_leverage(account_name, symbol, leverage=None) -> bool

# 平仓
close_position(account_name, symbol) -> bool

# 在所有账户执行
execute_on_all(symbol, side, entry_price=None, leverage=None) -> Dict
```

---

## 🎉 功能总结

✅ **多交易所支持** - 同时管理多个交易所账户  
✅ **灵活杠杆配置** - 每个账户独立设置 1x-125x  
✅ **双模式仓位计算** - 风险百分比或固定保证金  
✅ **自动仓位计算** - 无需手动计算交易数量  
✅ **独立配置** - 每个账户独立参数  
✅ **批量操作** - 一键在所有账户执行  
✅ **配置持久化** - JSON 文件保存  
✅ **向后兼容** - 兼容原有配置方式  

---

## 🤔 你还想添加什么功能？

你提到 "我也希望能添加" 但没说完，请告诉我：

1. **止盈止损管理**？
   - 自动设置 TP/SL 订单
   - 分批止盈
   - 追踪止损

2. **信号过滤**？
   - 只交易特定交易对
   - 交易时间段限制
   - 最小/最大价格过滤

3. **通知系统**？
   - Telegram 通知
   - 邮件通知
   - 微信通知

4. **交易记录**？
   - 数据库记录
   - 盈亏统计
   - 导出 Excel

5. **其他功能**？

**请告诉我，我会立即为你实现！** 🚀

