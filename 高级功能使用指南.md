## ğŸ‰ é«˜çº§åŠŸèƒ½å·²å®ç°ï¼

# é«˜çº§è®¢å•ç®¡ç†å’Œé£æ§ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## âœ¨ å·²å®ç°çš„åŠŸèƒ½

### 1. è‡ªåŠ¨ TP/SL è®¢å•ç®¡ç† âœ…
- è‡ªåŠ¨è®¾ç½®æ­¢æŸè®¢å•
- åˆ†æ‰¹æ­¢ç›ˆï¼ˆTP1, TP2, TP3...ï¼‰
- è¿½è¸ªæ­¢æŸï¼ˆTrailing Stopï¼‰
- ç§»åŠ¨æ­¢æŸåˆ°æˆæœ¬ä»·

### 2. é£é™©æ§åˆ¶ç³»ç»Ÿ âœ…
- æœ€å¤§æ—¥äºæŸé™åˆ¶ï¼ˆç™¾åˆ†æ¯”å’Œé‡‘é¢ï¼‰
- æœ€å¤§æ€»äºæŸé™åˆ¶
- è¿ç»­äºæŸä¿æŠ¤
- è‡ªåŠ¨å†·å´æœŸ
- æœ€å¤§æŒä»“æ•°é™åˆ¶

### 3. æ•°æ®åº“è®°å½•ç³»ç»Ÿ âœ…
- SQLite å®Œæ•´è®°å½•æ‰€æœ‰äº¤æ˜“
- è®¢å•å†å²
- æ¯æ—¥ç»Ÿè®¡
- ä¿¡å·è®°å½•
- é£é™©äº‹ä»¶æ—¥å¿—

### 4. ç›ˆäºç»Ÿè®¡åˆ†æ âœ…
- è¯¦ç»†äº¤æ˜“æŠ¥å‘Š
- ç›ˆäºæ›²çº¿ç”Ÿæˆ
- æŒ‰äº¤æ˜“å¯¹ç»Ÿè®¡
- æ—¶é—´æ®µåˆ†æ
- CSV å¯¼å‡ºåŠŸèƒ½

---

## ğŸ“ æ–°å¢æ–‡ä»¶

1. **`order_manager.py`** - è®¢å•ç®¡ç†ç³»ç»Ÿï¼ˆ400+ è¡Œï¼‰
2. **`risk_manager.py`** - é£é™©æ§åˆ¶ç³»ç»Ÿï¼ˆ350+ è¡Œï¼‰
3. **`database.py`** - æ•°æ®åº“ç®¡ç†ï¼ˆ400+ è¡Œï¼‰
4. **`statistics.py`** - ç»Ÿè®¡åˆ†æï¼ˆ300+ è¡Œï¼‰

**æ€»è®¡æ–°å¢ä»£ç ï¼š1,450+ è¡Œ**

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¤ºä¾‹ 1ï¼šåˆ›å»ºå¸¦å®Œæ•´ TP/SL çš„äº¤æ˜“

```python
from multi_exchange_client import multi_exchange_client
from order_manager import init_position_manager, TradePlan

# åˆå§‹åŒ–è®¢å•ç®¡ç†å™¨
position_manager = init_position_manager(multi_exchange_client)

# åˆ›å»ºäº¤æ˜“è®¡åˆ’
trade_plan = TradePlan(
    symbol='BTC/USDT',
    side='buy',  # åšå¤š
    entry_price=42000,
    stop_loss=41000,  # æ­¢æŸ
    take_profits=[43000, 44000, 45000],  # 3ä¸ªæ­¢ç›ˆç›®æ ‡
    tp_portions=[30, 30, 40],  # æ­¢ç›ˆæ¯”ä¾‹ï¼š30%, 30%, 40%
    leverage=10,  # 10å€æ æ†
    trailing_stop_pct=2.0,  # 2%è¿½è¸ªæ­¢æŸ
    move_sl_to_breakeven=True,  # ç›ˆåˆ©åç§»åŠ¨æ­¢æŸåˆ°æˆæœ¬ä»·
    breakeven_trigger_pct=1.0  # ç›ˆåˆ©1%åè§¦å‘
)

# æ‰§è¡Œäº¤æ˜“è®¡åˆ’
result = position_manager.create_position_with_plan(
    account_name='å¸å®‰ä¸»è´¦æˆ·',
    trade_plan=trade_plan,
    position_size=0.1  # 0.1 BTC
)

print(f"å…¥åœºè®¢å•: {result['entry_order']}")
print(f"æ­¢æŸè®¢å•: {result['stop_loss_order']}")
print(f"æ­¢ç›ˆè®¢å•: {len(result['take_profit_orders'])} ä¸ª")
```

### ç¤ºä¾‹ 2ï¼šè®¾ç½®é£é™©é™åˆ¶

```python
from risk_manager import init_risk_manager, RiskLimits

# åˆ›å»ºé£é™©é™åˆ¶é…ç½®
limits = RiskLimits(
    max_daily_loss_pct=5.0,  # æœ€å¤§æ—¥äºæŸ 5%
    max_daily_loss_amount=500.0,  # æˆ–æœ€å¤§ 500 USDT
    max_total_loss_pct=20.0,  # æœ€å¤§æ€»äºæŸ 20%
    max_consecutive_losses=3,  # æœ€å¤šè¿ç»­äºæŸ 3 æ¬¡
    max_open_positions=5,  # æœ€å¤šåŒæ—¶ 5 ä¸ªä»“ä½
    cooldown_after_limit=60,  # è§¦å‘é™åˆ¶åå†·å´ 60 åˆ†é’Ÿ
    min_account_balance=100.0  # æœ€ä½ä½™é¢ 100 USDT
)

# åˆå§‹åŒ–é£é™©ç®¡ç†å™¨
risk_manager = init_risk_manager(multi_exchange_client, limits)

# æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€ä»“
can_trade, reason = risk_manager.can_open_trade('å¸å®‰ä¸»è´¦æˆ·', 1000.0)
if can_trade:
    print("âœ“ å…è®¸å¼€ä»“")
else:
    print(f"âœ— ç¦æ­¢å¼€ä»“: {reason}")
```

### ç¤ºä¾‹ 3ï¼šè®°å½•å’Œåˆ†æäº¤æ˜“

```python
from database import trading_db
from statistics import trading_stats

# è®°å½•æ–°äº¤æ˜“
trade_id = trading_db.record_trade(
    account_name='å¸å®‰ä¸»è´¦æˆ·',
    symbol='BTC/USDT',
    side='buy',
    entry_price=42000,
    position_size=0.1,
    leverage=10,
    stop_loss=41000,
    take_profit=[43000, 44000, 45000],
    trailing_stop_pct=2.0,
    notes="æµ‹è¯•äº¤æ˜“"
)

# å¹³ä»“æ—¶æ›´æ–°
trading_db.close_trade(trade_id, exit_price=43500, fees=5.0)

# ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
report = trading_stats.generate_report('å¸å®‰ä¸»è´¦æˆ·', days=30)
print(report)

# è·å–ç›ˆäºæ›²çº¿
curve = trading_stats.generate_pnl_curve('å¸å®‰ä¸»è´¦æˆ·')

# å¯¼å‡ºåˆ° CSV
trading_stats.export_to_csv('å¸å®‰ä¸»è´¦æˆ·', 'my_trades.csv')
```

---

## ğŸ“Š è¯¦ç»†åŠŸèƒ½è¯´æ˜

### 1. è®¢å•ç®¡ç†ç³»ç»Ÿ

#### 1.1 åˆ†æ‰¹æ­¢ç›ˆï¼ˆPartial Take Profitï¼‰

```python
trade_plan = TradePlan(
    symbol='ETH/USDT',
    side='buy',
    entry_price=2500,
    take_profits=[2600, 2700, 2800],  # 3ä¸ªæ­¢ç›ˆç‚¹
    tp_portions=[25, 35, 40],  # åˆ†åˆ«å¹³25%, 35%, 40%
)
```

**å·¥ä½œåŸç†ï¼š**
- TP1 @ 2600: å¹³ä»“ 25% ä»“ä½
- TP2 @ 2700: å¹³ä»“ 35% ä»“ä½
- TP3 @ 2800: å¹³ä»“ 40% ä»“ä½

**å¥½å¤„ï¼š**
- é”å®šéƒ¨åˆ†åˆ©æ¶¦
- ä¿ç•™ä»“ä½è¿½æ±‚æ›´å¤§æ”¶ç›Š
- é™ä½é£é™©

#### 1.2 è¿½è¸ªæ­¢æŸï¼ˆTrailing Stopï¼‰

```python
trade_plan = TradePlan(
    symbol='BTC/USDT',
    side='buy',
    entry_price=42000,
    trailing_stop_pct=2.0,  # 2% è¿½è¸ªæ­¢æŸ
)

# ç¨‹åºä¼šè‡ªåŠ¨ç›‘æ§å¹¶æ›´æ–°æ­¢æŸ
position_manager.monitor_positions()  # åœ¨å¾ªç¯ä¸­è°ƒç”¨
```

**å·¥ä½œåŸç†ï¼š**
```
å…¥åœºä»·æ ¼: 42,000
æœ€é«˜ä»·: 42,000 â†’ æ­¢æŸ: 41,160 (42000 * 0.98)
æœ€é«˜ä»·: 43,000 â†’ æ­¢æŸ: 42,140 (43000 * 0.98) âœ“ æ›´æ–°
æœ€é«˜ä»·: 44,000 â†’ æ­¢æŸ: 43,120 (44000 * 0.98) âœ“ æ›´æ–°
ä»·æ ¼å›è½: 43,500 â†’ æ­¢æŸä»ä¸º 43,120
ä»·æ ¼è§¦åŠ: 43,120 â†’ å¹³ä»“
```

**å¥½å¤„ï¼š**
- è‡ªåŠ¨ä¿æŠ¤åˆ©æ¶¦
- ä¸é™åˆ¶ä¸Šæ¶¨ç©ºé—´
- é€‚åˆè¶‹åŠ¿è¡Œæƒ…

#### 1.3 ç§»åŠ¨æ­¢æŸåˆ°æˆæœ¬ä»·

```python
trade_plan = TradePlan(
    symbol='BTC/USDT',
    side='buy',
    entry_price=42000,
    stop_loss=41000,  # åˆå§‹æ­¢æŸ
    move_sl_to_breakeven=True,
    breakeven_trigger_pct=1.0,  # ç›ˆåˆ©1%åè§¦å‘
)
```

**å·¥ä½œåŸç†ï¼š**
```
å…¥åœºä»·æ ¼: 42,000
åˆå§‹æ­¢æŸ: 41,000 (é£é™© 2.38%)
å½“ä»·æ ¼è¾¾åˆ°: 42,420 (ç›ˆåˆ©1%) â†’ æ­¢æŸç§»è‡³: 42,042 (æˆæœ¬ä»·+0.1%æ‰‹ç»­è´¹)
é£é™©ä» 1,000 USDT â†’ 0 USDT (ä¿æœ¬)
```

**å¥½å¤„ï¼š**
- å®ç°ä¿æœ¬äº¤æ˜“
- æ¶ˆé™¤å¿ƒç†å‹åŠ›
- é€‚åˆä¸ç¡®å®šè¡Œæƒ…

---

### 2. é£é™©æ§åˆ¶ç³»ç»Ÿ

#### 2.1 æœ€å¤§äºæŸé™åˆ¶

```python
limits = RiskLimits(
    max_daily_loss_pct=5.0,  # æ¯æ—¥æœ€å¤§äºæŸ5%
    max_daily_loss_amount=500.0,  # æˆ–500 USDT
    max_total_loss_pct=20.0,  # æ€»æœ€å¤§äºæŸ20%
)
```

**è§¦å‘æ¡ä»¶ï¼š**
- å½“æ—¥äºæŸ â‰¥ 5% è´¦æˆ·ä½™é¢ **æˆ–** â‰¥ 500 USDT
- æ€»äºæŸ â‰¥ 20% åˆå§‹ä½™é¢

**è§¦å‘åï¼š**
- ğŸš« ç¦æ­¢æ–°å¼€ä»“
- â° è¿›å…¥å†·å´æœŸï¼ˆé»˜è®¤60åˆ†é’Ÿï¼‰
- ğŸ“ è®°å½•é£é™©äº‹ä»¶
- ğŸ“§ å¯é…ç½®é€šçŸ¥ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

#### 2.2 è¿ç»­äºæŸä¿æŠ¤

```python
limits = RiskLimits(
    max_consecutive_losses=3,  # æœ€å¤šè¿ç»­äºæŸ3æ¬¡
    cooldown_after_limit=60,  # å†·å´60åˆ†é’Ÿ
)
```

**ç¤ºä¾‹åœºæ™¯ï¼š**
```
äº¤æ˜“1: -50 USDT (è¿äº1)
äº¤æ˜“2: -30 USDT (è¿äº2)
äº¤æ˜“3: -40 USDT (è¿äº3) â†’ ğŸš« è§¦å‘ä¿æŠ¤ï¼Œæš‚åœäº¤æ˜“60åˆ†é’Ÿ
```

**ç›®çš„ï¼š**
- é˜²æ­¢æƒ…ç»ªåŒ–äº¤æ˜“
- ç»™æ—¶é—´é‡æ–°è¯„ä¼°ç­–ç•¥
- é¿å…è¿ç»­åŠ æ·±äºæŸ

#### 2.3 å®æ—¶é£é™©ç›‘æ§

```python
# è·å–é£é™©çŠ¶æ€
risk_status = risk_manager.get_risk_status('å¸å®‰ä¸»è´¦æˆ·')

print(f"äº¤æ˜“çŠ¶æ€: {risk_status['trading_enabled']}")
print(f"æ¯æ—¥ç›ˆäº: {risk_status['daily_pnl']:.2f} USDT")
print(f"è¿ç»­äºæŸ: {risk_status['consecutive_losses']} æ¬¡")
print(f"èƒœç‡: {risk_status['win_rate']:.2f}%")
print(f"æŒä»“æ•°: {risk_status['open_positions_count']}")

# æ‰‹åŠ¨æ“ä½œ
risk_manager.manually_disable_trading('å¸å®‰ä¸»è´¦æˆ·', "å¸‚åœºå¼‚å¸¸")
risk_manager.manually_enable_trading('å¸å®‰ä¸»è´¦æˆ·')
risk_manager.reset_account('å¸å®‰ä¸»è´¦æˆ·')
```

---

### 3. æ•°æ®åº“è®°å½•ç³»ç»Ÿ

#### 3.1 æ•°æ®åº“ç»“æ„

**5ä¸ªæ ¸å¿ƒè¡¨ï¼š**

1. **trades** - äº¤æ˜“è®°å½•
   - å…¥åœº/å‡ºåœºä»·æ ¼
   - ä»“ä½å¤§å°å’Œæ æ†
   - ç›ˆäºå’Œæ‰‹ç»­è´¹
   - TP/SL è®¾ç½®

2. **orders** - è®¢å•è®°å½•
   - è®¢å•ç±»å‹ï¼ˆå…¥åœº/æ­¢ç›ˆ/æ­¢æŸï¼‰
   - è®¢å•çŠ¶æ€
   - æˆäº¤ä¿¡æ¯

3. **daily_stats** - æ¯æ—¥ç»Ÿè®¡
   - äº¤æ˜“æ¬¡æ•°
   - èƒœç‡
   - ç›ˆäºæ€»é¢

4. **signals** - ä¿¡å·è®°å½•
   - åŸå§‹ä¿¡å·
   - è§£æç»“æœ
   - æ‰§è¡ŒçŠ¶æ€

5. **risk_events** - é£é™©äº‹ä»¶
   - äº‹ä»¶ç±»å‹
   - ä¸¥é‡ç¨‹åº¦
   - è¯¦ç»†æè¿°

#### 3.2 æŸ¥è¯¢ç¤ºä¾‹

```python
# è·å–æœ€è¿‘100ç¬”äº¤æ˜“
trades = trading_db.get_trades('å¸å®‰ä¸»è´¦æˆ·', limit=100)

# è·å–è¿›è¡Œä¸­çš„äº¤æ˜“
open_trades = trading_db.get_trades('å¸å®‰ä¸»è´¦æˆ·', status='open')

# è·å–30å¤©æ¯æ—¥ç»Ÿè®¡
daily = trading_db.get_daily_stats('å¸å®‰ä¸»è´¦æˆ·', days=30)

# è·å–æ€»ä½“ç»Ÿè®¡
summary = trading_db.get_summary_stats('å¸å®‰ä¸»è´¦æˆ·')
print(f"æ€»äº¤æ˜“: {summary['total_trades']}")
print(f"èƒœç‡: {summary['win_rate']:.2f}%")
print(f"æ€»ç›ˆäº: {summary['total_pnl']:.2f} USDT")
```

---

### 4. ç»Ÿè®¡åˆ†æç³»ç»Ÿ

#### 4.1 ç”Ÿæˆäº¤æ˜“æŠ¥å‘Š

```python
# ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š
report = trading_stats.generate_report('å¸å®‰ä¸»è´¦æˆ·', days=30)
print(report)
```

**æŠ¥å‘Šç¤ºä¾‹ï¼š**
```
============================================================
äº¤æ˜“æŠ¥å‘Š - å¸å®‰ä¸»è´¦æˆ·
ç»Ÿè®¡å‘¨æœŸ: æœ€è¿‘ 30 å¤©
ç”Ÿæˆæ—¶é—´: 2024-01-15 10:30:00
============================================================

ã€åŸºæœ¬ç»Ÿè®¡ã€‘
  æ€»äº¤æ˜“æ¬¡æ•°: 45
  ç›ˆåˆ©äº¤æ˜“: 28
  äºæŸäº¤æ˜“: 17
  èƒœç‡: 62.22%

ã€ç›ˆäºç»Ÿè®¡ã€‘
  æ€»ç›ˆäº: +1,234.56 USDT
  å¹³å‡ç›ˆäº: +27.43 USDT
  æœ€å¤§å•ç¬”ç›ˆåˆ©: +245.00 USDT
  æœ€å¤§å•ç¬”äºæŸ: -89.50 USDT
  ç›ˆäºæ¯”: 2.15

ã€é£é™©æŒ‡æ ‡ã€‘
  æœ€å¤§å›æ’¤: 156.30 USDT
  å¤æ™®æ¯”ç‡: 1.45
  å¹³å‡æŒä»“æ—¶é—´: 4.25 å°æ—¶
  æ€»æ‰‹ç»­è´¹: 45.67 USDT
  æŠ•èµ„å›æŠ¥ç‡: 12.35%

ã€æœ€è¿‘5ç¬”äº¤æ˜“ã€‘
  1. BTC/USDT - BUY - +125.30 USDT
  2. ETH/USDT - BUY - -45.20 USDT
  3. BTC/USDT - SELL - +89.40 USDT
  4. SOL/USDT - BUY - +67.80 USDT
  5. ETH/USDT - BUY - +34.50 USDT

============================================================
```

#### 4.2 ç›ˆäºæ›²çº¿

```python
# è·å–ç›ˆäºæ›²çº¿æ•°æ®
curve_data = trading_stats.generate_pnl_curve('å¸å®‰ä¸»è´¦æˆ·')

# æ•°æ®æ ¼å¼
for point in curve_data[:5]:
    print(f"{point['date']}: {point['cumulative_pnl']:.2f} USDT")

# å¯ä»¥ç”¨äºç»˜å›¾
import matplotlib.pyplot as plt

dates = [p['date'] for p in curve_data]
pnls = [p['cumulative_pnl'] for p in curve_data]

plt.plot(dates, pnls)
plt.title('ç´¯è®¡ç›ˆäºæ›²çº¿')
plt.xlabel('æ—¥æœŸ')
plt.ylabel('ç›ˆäº (USDT)')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig('pnl_curve.png')
```

#### 4.3 æŒ‰äº¤æ˜“å¯¹åˆ†æ

```python
# è·å–å„äº¤æ˜“å¯¹è¡¨ç°
symbol_stats = trading_stats.get_symbol_performance('å¸å®‰ä¸»è´¦æˆ·')

for symbol, stats in symbol_stats.items():
    print(f"{symbol}:")
    print(f"  äº¤æ˜“æ¬¡æ•°: {stats['total_trades']}")
    print(f"  èƒœç‡: {stats['win_rate']:.2f}%")
    print(f"  æ€»ç›ˆäº: {stats['total_pnl']:.2f} USDT")
    print()
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
BTC/USDT:
  äº¤æ˜“æ¬¡æ•°: 25
  èƒœç‡: 68.00%
  æ€»ç›ˆäº: +856.30 USDT

ETH/USDT:
  äº¤æ˜“æ¬¡æ•°: 15
  èƒœç‡: 53.33%
  æ€»ç›ˆäº: +234.50 USDT

SOL/USDT:
  äº¤æ˜“æ¬¡æ•°: 5
  èƒœç‡: 60.00%
  æ€»ç›ˆäº: +143.76 USDT
```

#### 4.4 æ—¶é—´æ®µåˆ†æ

```python
# åˆ†ææœ€ä½³äº¤æ˜“æ—¶é—´
time_analysis = trading_stats.get_time_analysis('å¸å®‰ä¸»è´¦æˆ·')

# æŒ‰å°æ—¶
print("æœ€ä½³äº¤æ˜“å°æ—¶:")
for hour, stats in time_analysis['by_hour'].items():
    if stats['total'] > 0:
        print(f"  {hour:02d}:00 - èƒœç‡: {stats['win_rate']:.1f}%, "
              f"ç›ˆäº: {stats['pnl']:.2f}")

# æŒ‰æ˜ŸæœŸ
print("\næœ€ä½³äº¤æ˜“æ—¥:")
for day, stats in time_analysis['by_weekday'].items():
    if stats['total'] > 0:
        print(f"  {day} - èƒœç‡: {stats['win_rate']:.1f}%, "
              f"ç›ˆäº: {stats['pnl']:.2f}")
```

#### 4.5 å¯¼å‡ºåˆ° Excel/CSV

```python
# å¯¼å‡ºäº¤æ˜“è®°å½•
trading_stats.export_to_csv('å¸å®‰ä¸»è´¦æˆ·', 'trades_2024.csv')

# å¯ä»¥åœ¨ Excel ä¸­æ‰“å¼€è¿›è¡Œè¿›ä¸€æ­¥åˆ†æ
```

---

## ğŸ¯ å®Œæ•´ä½¿ç”¨æµç¨‹

### æ­¥éª¤ 1ï¼šåˆå§‹åŒ–æ‰€æœ‰ç³»ç»Ÿ

```python
from multi_exchange_client import multi_exchange_client
from order_manager import init_position_manager
from risk_manager import init_risk_manager, RiskLimits
from database import trading_db
from statistics import trading_stats

# 1. åˆå§‹åŒ–è®¢å•ç®¡ç†å™¨
position_manager = init_position_manager(multi_exchange_client)

# 2. è®¾ç½®é£é™©é™åˆ¶
limits = RiskLimits(
    max_daily_loss_pct=5.0,
    max_consecutive_losses=3,
    max_open_positions=5
)
risk_manager = init_risk_manager(multi_exchange_client, limits)

# 3. æ•°æ®åº“å’Œç»Ÿè®¡å·²è‡ªåŠ¨åˆå§‹åŒ–
print("âœ“ æ‰€æœ‰ç³»ç»Ÿå·²åˆå§‹åŒ–")
```

### æ­¥éª¤ 2ï¼šæ¥æ”¶ä¿¡å·å¹¶æ‰§è¡Œ

```python
from signal_parser import SignalParser

# è§£æ Telegram ä¿¡å·
parser = SignalParser()
signal = parser.parse(telegram_message)

if signal:
    account_name = 'å¸å®‰ä¸»è´¦æˆ·'
    
    # 1. æ£€æŸ¥é£é™©é™åˆ¶
    can_trade, reason = risk_manager.can_open_trade(account_name, 1000.0)
    
    if not can_trade:
        print(f"âš  æ— æ³•å¼€ä»“: {reason}")
        return
    
    # 2. è®°å½•ä¿¡å·åˆ°æ•°æ®åº“
    signal_id = trading_db.record_signal(
        symbol=signal.symbol,
        signal_type=signal.signal_type.value,
        entry_price=signal.entry_price,
        stop_loss=signal.stop_loss,
        take_profit=signal.take_profit,
        leverage=signal.leverage,
        raw_message=telegram_message
    )
    
    # 3. åˆ›å»ºäº¤æ˜“è®¡åˆ’
    trade_plan = TradePlan(
        symbol=signal.symbol,
        side='buy' if signal.signal_type.value == 'LONG' else 'sell',
        entry_price=signal.entry_price,
        stop_loss=signal.stop_loss,
        take_profits=signal.take_profit,
        leverage=signal.leverage,
        trailing_stop_pct=2.0,  # æ·»åŠ è¿½è¸ªæ­¢æŸ
        move_sl_to_breakeven=True,  # æ·»åŠ ä¿æœ¬æ­¢æŸ
    )
    
    # 4. æ‰§è¡Œäº¤æ˜“
    result = position_manager.create_position_with_plan(
        account_name=account_name,
        trade_plan=trade_plan,
        position_size=None  # è‡ªåŠ¨è®¡ç®—
    )
    
    if result['status'] == 'success':
        # 5. æ ‡è®°ä¿¡å·å·²æ‰§è¡Œ
        trading_db.mark_signal_executed(signal_id)
        
        # 6. è®°å½•å¼€ä»“åˆ°æ•°æ®åº“
        trade_id = trading_db.record_trade(
            account_name=account_name,
            symbol=signal.symbol,
            side=trade_plan.side,
            entry_price=signal.entry_price or 0,
            position_size=result['entry_order']['amount'] if result['entry_order'] else 0,
            leverage=signal.leverage or 1,
            stop_loss=signal.stop_loss,
            take_profit=signal.take_profit,
            trailing_stop_pct=2.0
        )
        
        # 7. è®°å½•é£é™©ç®¡ç†
        risk_manager.record_trade(account_name, 0, closed=False)
        
        print(f"âœ“ äº¤æ˜“å·²æ‰§è¡Œ: ID={trade_id}")
```

### æ­¥éª¤ 3ï¼šç›‘æ§å’Œæ›´æ–°

```python
import time

# æŒç»­ç›‘æ§å¾ªç¯
while True:
    # 1. æ›´æ–°è¿½è¸ªæ­¢æŸå’Œä¿æœ¬æ­¢æŸ
    position_manager.monitor_positions()
    
    # 2. æ£€æŸ¥é£é™©çŠ¶æ€
    risk_status = risk_manager.get_risk_status('å¸å®‰ä¸»è´¦æˆ·')
    
    if not risk_status['trading_enabled']:
        print(f"âš  äº¤æ˜“å·²æš‚åœ: å†·å´è‡³ {risk_status['cooldown_until']}")
    
    # 3. æ¯å°æ—¶ç”ŸæˆæŠ¥å‘Š
    if datetime.now().minute == 0:
        report = trading_stats.generate_report('å¸å®‰ä¸»è´¦æˆ·')
        # å¯ä»¥å‘é€åˆ° Telegram æˆ–ä¿å­˜
    
    time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

### æ­¥éª¤ 4ï¼šå¹³ä»“æ—¶å¤„ç†

```python
# å½“äº¤æ˜“å¹³ä»“æ—¶ï¼ˆæ‰‹åŠ¨æˆ–è§¦å‘æ­¢ç›ˆ/æ­¢æŸï¼‰
def on_position_closed(trade_id, exit_price, fees):
    # 1. æ›´æ–°æ•°æ®åº“
    trading_db.close_trade(trade_id, exit_price, fees)
    
    # 2. è®¡ç®—ç›ˆäº
    trade = trading_db.get_trades(limit=1)[0]  # è·å–æœ€æ–°äº¤æ˜“
    pnl = trade['pnl']
    
    # 3. æ›´æ–°é£é™©ç®¡ç†
    risk_manager.record_trade(trade['account_name'], pnl, closed=True)
    
    # 4. æ£€æŸ¥æ˜¯å¦è§¦å‘é£é™©é™åˆ¶
    can_trade, reason = risk_manager.can_open_trade(trade['account_name'], 0)
    if not can_trade:
        # è®°å½•é£é™©äº‹ä»¶
        trading_db.record_risk_event(
            account_name=trade['account_name'],
            event_type='RISK_LIMIT_TRIGGERED',
            description=reason,
            severity='WARNING'
        )
    
    print(f"âœ“ äº¤æ˜“å·²å¹³ä»“: PnL={pnl:.2f} USDT")
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆ†æ‰¹æ­¢ç›ˆè®¾ç½®

**ä¿å®ˆå‹ï¼ˆ3ä¸ªæ­¢ç›ˆç‚¹ï¼‰ï¼š**
```python
take_profits=[price*1.01, price*1.02, price*1.03]  # 1%, 2%, 3%
tp_portions=[30, 30, 40]  # å¿«é€Ÿé”å®š70%åˆ©æ¶¦
```

**é€‚ä¸­å‹ï¼ˆ4ä¸ªæ­¢ç›ˆç‚¹ï¼‰ï¼š**
```python
take_profits=[price*1.015, price*1.03, price*1.05, price*1.08]
tp_portions=[25, 25, 25, 25]  # å¹³å‡åˆ†é…
```

**æ¿€è¿›å‹ï¼ˆ5ä¸ªæ­¢ç›ˆç‚¹ï¼‰ï¼š**
```python
take_profits=[price*1.02, price*1.04, price*1.06, price*1.08, price*1.12]
tp_portions=[15, 15, 20, 25, 25]  # åæœŸåˆ©æ¶¦æ›´å¤§
```

### 2. è¿½è¸ªæ­¢æŸè®¾ç½®

- **çŸ­çº¿äº¤æ˜“**ï¼š1-2% è¿½è¸ªæ­¢æŸ
- **ä¸­çº¿äº¤æ˜“**ï¼š2-3% è¿½è¸ªæ­¢æŸ
- **é•¿çº¿äº¤æ˜“**ï¼š3-5% è¿½è¸ªæ­¢æŸ

### 3. é£é™©é™åˆ¶å»ºè®®

**æ–°æ‰‹/å°èµ„é‡‘ï¼š**
```python
RiskLimits(
    max_daily_loss_pct=2.0,  # è°¨æ…
    max_consecutive_losses=2,
    max_open_positions=3
)
```

**æœ‰ç»éªŒ/ä¸­ç­‰èµ„é‡‘ï¼š**
```python
RiskLimits(
    max_daily_loss_pct=5.0,
    max_consecutive_losses=3,
    max_open_positions=5
)
```

**ä¸“ä¸šäº¤æ˜“è€…/å¤§èµ„é‡‘ï¼š**
```python
RiskLimits(
    max_daily_loss_pct=8.0,
    max_consecutive_losses=5,
    max_open_positions=10
)
```

---

## ğŸ“Š æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥çœ‹ä»Šæ—¥è¡¨ç°

```python
today_stats = trading_db.get_daily_stats('å¸å®‰ä¸»è´¦æˆ·', days=1)[0]
print(f"ä»Šæ—¥äº¤æ˜“: {today_stats['total_trades']}")
print(f"ä»Šæ—¥ç›ˆäº: {today_stats['total_pnl']:.2f} USDT")
print(f"ä»Šæ—¥èƒœç‡: {today_stats['win_rate']:.2f}%")
```

### æ‰¾å‡ºæœ€ä½³äº¤æ˜“å¯¹

```python
symbol_stats = trading_stats.get_symbol_performance('å¸å®‰ä¸»è´¦æˆ·')
best_symbol = max(symbol_stats.items(), key=lambda x: x[1]['total_pnl'])
print(f"æœ€ä½³äº¤æ˜“å¯¹: {best_symbol[0]}")
print(f"æ€»ç›ˆäº: {best_symbol[1]['total_pnl']:.2f} USDT")
```

### åˆ†æå¤±è´¥äº¤æ˜“

```python
trades = trading_db.get_trades('å¸å®‰ä¸»è´¦æˆ·', limit=1000, status='closed')
losing_trades = [t for t in trades if t['pnl'] and t['pnl'] < 0]

for trade in losing_trades[:5]:
    print(f"{trade['symbol']}: {trade['pnl']:.2f} USDT")
    print(f"  å…¥åœº: {trade['entry_price']}, å‡ºåœº: {trade['exit_price']}")
```

---

## ğŸ‰ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ª**ä¸“ä¸šçº§çš„äº¤æ˜“ç³»ç»Ÿ**ï¼ŒåŒ…æ‹¬ï¼š

âœ… **æ™ºèƒ½è®¢å•ç®¡ç†** - è‡ªåŠ¨ TP/SLï¼Œè¿½è¸ªæ­¢æŸï¼Œä¿æœ¬æ­¢æŸ  
âœ… **å®Œå–„é£æ§ç³»ç»Ÿ** - å¤šå±‚ä¿æŠ¤ï¼Œè‡ªåŠ¨å†·å´ï¼Œé£é™©ç›‘æ§  
âœ… **å®Œæ•´æ•°æ®è®°å½•** - SQLite æ•°æ®åº“ï¼Œæ°¸ä¹…ä¿å­˜  
âœ… **æ·±åº¦ç»Ÿè®¡åˆ†æ** - æŠ¥å‘Šç”Ÿæˆï¼Œæ›²çº¿åˆ†æï¼Œå¯¼å‡ºåŠŸèƒ½  

**ä»£ç æ€»è®¡ï¼š3,000+ è¡Œ**  
**åŠŸèƒ½æ¨¡å—ï¼š7 ä¸ª**  
**æ•°æ®åº“è¡¨ï¼š5 ä¸ª**  

å¼€å§‹ä½¿ç”¨è¿™äº›å¼ºå¤§çš„åŠŸèƒ½å§ï¼ğŸš€ğŸ“ˆğŸ’°

