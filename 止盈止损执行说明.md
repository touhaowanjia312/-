# 📊 止盈止损执行说明

## ✅ 问题已修复！

### 之前的问题
❌ **多交易所执行时，只下了入场订单，没有设置止盈止损！**

```python
# 之前的代码（错误）
order_result = self.multi_exchange.place_market_order(...)
logger.info("✓ 入场订单已执行")
# 就结束了！没有止盈止损！
```

### 现在的实现
✅ **完整的订单流程：入场 → 止损 → 止盈**

```python
# 修复后的代码
# 1. 入场订单
order_result = self.multi_exchange.place_market_order(...)

# 2. 止损订单
sl_order = self.multi_exchange.place_stop_loss_order(...)
logger.info("✓ 止损已设置")

# 3. 止盈订单（支持多个TP）
tp_order1 = self.multi_exchange.place_take_profit_order(...)
logger.info("✓ TP1 已设置: 价格 (30% 仓位)")

tp_order2 = self.multi_exchange.place_take_profit_order(...)
logger.info("✓ TP2 已设置: 价格 (30% 仓位)")

tp_order3 = self.multi_exchange.place_take_profit_order(...)
logger.info("✓ TP3 已设置: 价格 (40% 仓位)")
```

---

## 🎯 你的配置会这样应用

### 当前配置（来自 tpsl_config.json）
```json
{
  "default_stop_loss_percent": 8.0,
  "additional_tps": [
    { "profit_percent": 5.0, "portion_percent": 30.0 },   // TP1
    { "profit_percent": 10.0, "portion_percent": 30.0 },  // TP2
    { "profit_percent": 20.0, "portion_percent": 40.0 }   // TP3
  ],
  "trailing_stop": { "enabled": true, "percent": 3.0 },
  "breakeven": { "enabled": true, "trigger_percent": 1.0 }
}
```

### 实际执行示例

假设收到信号：`#BTC 市价多 第一止盈：50000`

#### 步骤1：创建订单计划
```
智能订单管理器分析：
✓ 信号提供了 TP1: 50000（使用这个）
✓ 信号没有提供 SL：使用默认 8%
✓ 自动添加 TP2、TP3（基于配置）

订单计划：
- 入场价：48000（市价）
- 止损：48000 * (1 - 0.08) = 44160
- TP1：50000（信号提供，30%仓位）
- TP2：48000 * (1 + 0.10) = 52800（程序添加，30%仓位）
- TP3：48000 * (1 + 0.20) = 57600（程序添加，40%仓位）
```

#### 步骤2：在LBANK执行
```
📍 正在 LBANK 执行...
  余额: 1000 USDT
  杠杆: 25x
  仓位大小: 0.5 BTC
  
  ✓ 入场订单已执行
  订单ID: 123456
  
  ✓ 止损已设置: 44160
  
  ✓ TP1 已设置: 50000 (30% 仓位, 数量: 0.15 BTC)
  ✓ TP2 已设置: 52800 (30% 仓位, 数量: 0.15 BTC)
  ✓ TP3 已设置: 57600 (40% 仓位, 数量: 0.20 BTC)
```

#### 步骤3：在Bitget执行
```
📍 正在 bitget 执行...
  余额: 500 USDT
  杠杆: 20x
  仓位大小: 0.2 BTC
  
  ✓ 入场订单已执行
  订单ID: 789012
  
  ✓ 止损已设置: 44160
  
  ✓ TP1 已设置: 50000 (30% 仓位, 数量: 0.06 BTC)
  ✓ TP2 已设置: 52800 (30% 仓位, 数量: 0.06 BTC)
  ✓ TP3 已设置: 57600 (40% 仓位, 数量: 0.08 BTC)
```

---

## 🔧 技术实现

### 添加的方法

#### 1. `place_stop_loss_order`
```python
def place_stop_loss_order(self, account_name: str, symbol: str, 
                          side: str, amount: float, stop_price: float):
    """
    设置止损订单
    - 使用 stop_market 订单类型
    - 设置 reduceOnly=True（只减仓，不开新仓）
    - 触发价到达时自动以市价平仓
    """
```

#### 2. `place_take_profit_order`
```python
def place_take_profit_order(self, account_name: str, symbol: str, 
                           side: str, amount: float, tp_price: float):
    """
    设置止盈订单
    - 使用 limit 限价单
    - 设置 reduceOnly=True（只减仓）
    - 支持分批止盈（多个TP订单）
    """
```

---

## 📊 完整的执行流程

### 1. 信号接收
```
Telegram群组 → 收到信号 → 解析信号
```

### 2. 订单计划
```
smart_order_manager.create_order_plan(signal)
↓
合并：信号TP/SL + 用户配置TP/SL
↓
生成完整订单计划
```

### 3. 多交易所执行
```
for 每个交易所:
  1. 计算仓位大小
  2. 下入场订单（市价单）
     ✓ 成功
  3. 设置止损订单（stop_market）
     ✓ 止损已设置
  4. 设置止盈订单（limit）
     ✓ TP1 已设置
     ✓ TP2 已设置
     ✓ TP3 已设置
```

---

## ⚙️ 订单类型说明

### 入场订单
- **类型：** Market Order（市价单）
- **作用：** 立即以当前市场价开仓
- **参数：** symbol, side, amount

### 止损订单
- **类型：** Stop Market Order（止损市价单）
- **作用：** 价格达到止损价时，自动以市价平仓
- **参数：** 
  - `stopPrice`: 触发价格
  - `reduceOnly`: True（只平仓）
  - `side`: 与开仓方向相反

### 止盈订单
- **类型：** Limit Order（限价单）
- **作用：** 价格达到目标价时，以限价平仓
- **参数：**
  - `price`: 目标价格
  - `reduceOnly`: True（只平仓）
  - `side`: 与开仓方向相反
  - `amount`: 部分仓位（支持分批）

---

## 🎯 风险管理特性

### 1. 分批止盈 ✅
```
TP1: 30% 仓位 → 锁定部分利润
TP2: 30% 仓位 → 继续获利
TP3: 40% 仓位 → 追求更高收益
```

### 2. 止损保护 ✅
```
所有订单都设置止损
最大亏损: 8%（可配置）
```

### 3. 只减仓模式 ✅
```
reduceOnly: True
→ 防止意外开新仓
→ 只用于平仓现有持仓
```

### 4. 智能合并 ✅
```
优先使用交易员提供的TP/SL
自动补充额外的TP2/TP3
保证风控完整性
```

---

## 📝 测试建议

### 测试1：验证配置读取
```bash
python test_multi_exchange_signal.py
```
应该看到：
- ✓ 配置已加载
- ✓ 显示你的TP/SL设置

### 测试2：模拟信号执行
```
1. 启动GUI
2. 点击 "信号测试" 标签
3. 输入测试信号
4. 查看日志确认：
   - ✓ 入场订单
   - ✓ 止损订单
   - ✓ TP1/TP2/TP3 订单
```

### 测试3：实际交易（小仓位）
```
1. 充值小额资金（如10 USDT）
2. 启动监听
3. 发送测试信号
4. 在交易所查看：
   - 持仓是否正确
   - 止损单是否存在
   - 止盈单是否存在
```

---

## ⚠️ 重要提醒

### 交易所差异
不同交易所的订单类型支持可能不同：
- **Binance:** ✓ 完全支持
- **Bitget:** ✓ 支持，需要password
- **LBANK:** ⚠️ 需要确认是否支持 stop_market

### 如果某个交易所不支持
程序会：
1. 尝试设置止盈止损
2. 如果失败，记录警告
3. 继续执行（至少保证入场订单成功）

### 手动监控
建议在初期：
- ✓ 使用小仓位测试
- ✓ 在交易所界面确认订单
- ✓ 观察日志是否有错误

---

## ✅ 总结

### 修复内容
1. ✅ 添加了 `place_stop_loss_order` 方法
2. ✅ 添加了 `place_take_profit_order` 方法
3. ✅ 在多交易所执行中调用这些方法
4. ✅ 完整的日志记录

### 你的配置现在会：
- ✅ 被正确读取
- ✅ 被应用到每个交易所
- ✅ 每个订单都有止盈止损
- ✅ 支持分批止盈（TP1/TP2/TP3）
- ✅ 自动风险管理

**现在可以放心使用了！** 🎉

